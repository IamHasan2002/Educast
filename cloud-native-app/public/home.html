<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduCast | Home</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .collapsed-content {
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .collapsed-content::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: linear-gradient(transparent, var(--surface));
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-graduation-cap"></i>
            EduCast
        </div>
        <div
            style="background: var(--surface); padding: 0.5rem 1rem; border-radius: 99px; display: flex; align-items: center; gap: 0.5rem; border: 1px solid var(--border); flex: 1;">
            <i class="fa-solid fa-search" id="search-icon" style="cursor: pointer;"></i>
            <input type="text" id="search-input" placeholder="Search..."
                style="border: none; outline: none; background: transparent; width: 100%;">
        </div>

        <!-- Filter Toggle Button -->
        <button id="filter-toggle"
            style="background: var(--surface); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer;">
            <i class="fa-solid fa-sliders"></i> Filters
        </button>
        </div>

        <!-- Collapsible Filter Menu -->
        <div id="filter-menu"
            style="display: none; padding: 1rem; background: var(--surface); border-bottom: 1px solid var(--border); gap: 1rem; flex-wrap: wrap; justify-content: center;">
            <select id="filter-university"
                style="padding: 0.5rem; border-radius: 10px; border: 1px solid var(--border);">
                <option value="">All Universities</option>
                <option value="Ulster University">Ulster University</option>
                <option value="Leeds Beckett">Leeds Beckett</option>
                <option value="Queens University">Queens University</option>
            </select>

            <select id="filter-subject" style="padding: 0.5rem; border-radius: 10px; border: 1px solid var(--border);">
                <option value="">All Subjects</option>
                <option value="CSE">CSE</option>
                <option value="Business">Business</option>
                <option value="Art">Art</option>
            </select>

            <select id="filter-role" style="padding: 0.5rem; border-radius: 10px; border: 1px solid var(--border);">
                <option value="">All Roles</option>
                <option value="Student">Student</option>
                <option value="Teacher">Teacher</option>
            </select>

            <select id="filter-country" style="padding: 0.5rem; border-radius: 10px; border: 1px solid var(--border);">
                <option value="">All Countries</option>
                <option value="United Kingdom">UK</option>
                <option value="USA">USA</option>
                <option value="Bangladesh">Bangladesh</option>
            </select>

            <select id="filter-media" style="padding: 0.5rem; border-radius: 10px; border: 1px solid var(--border);">
                <option value="">All Media</option>
                <option value="pdf">PDF Documents</option>
                <option value="image">Images</option>
                <option value="video">Videos</option>
                <option value="audio">Audio (MP3)</option>
            </select>
        </div>
        <div style="display: flex; gap: 1.5rem; align-items: center;">
            <button class="btn btn-icon"><i class="fa-regular fa-bell"></i></button>
            <button class="btn btn-icon"><i class="fa-regular fa-envelope"></i></button>
            <a href="dashboard.html" class="avatar" style="width: 32px; height: 32px; cursor: pointer;">
                <img src="https://ui-avatars.com/api/?name=User" id="nav-avatar" alt="Me">
            </a>
        </div>
    </nav>

    <div class="app-container">
        <!-- Sidebar Left: Quick Stats -->
        <aside class="sidebar">
            <div class="card" style="text-align: center;">
                <div
                    style="margin: -3rem auto 1rem auto; width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; overflow: hidden; background: #2563eb; position: relative; top: 1rem;">
                    <!-- Simple avatar offset hack -->
                    <img src="https://ui-avatars.com/api/?name=User" id="side-avatar"
                        style="width: 100%; height: 100%;">
                </div>
                <h3 id="side-name" style="margin-top: 1.5rem; font-size: 1.1rem;">User</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Computer Science Student
                </p>

                <div style="border-top: 1px solid var(--border); padding-top: 1rem; text-align: left;">
                    <a href="dashboard.html" class="btn btn-outline"
                        style="width: 100%; justify-content: flex-start; border: none;">
                        <i class="fa-regular fa-file-alt"></i> My Uploads
                    </a>
                    <a href="#" class="btn btn-outline" style="width: 100%; justify-content: flex-start; border: none;">
                        <i class="fa-regular fa-bookmark"></i> Saved Lists
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Feed -->
        <main class="feed">
            <!-- Create Post -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2 style="margin-bottom: 1rem; font-size: 1.2rem;">Create Post</h2>
                <form id="create-post-form">
                    <!-- Rich Text Toolbar -->
                    <div
                        style="background: var(--background); padding: 0.5rem; border-radius: 8px 8px 0 0; border: 1px solid var(--border); border-bottom: none; display: flex; gap: 0.5rem; align-items: center;">
                        <button type="button" class="btn btn-icon btn-sm" onclick="formatDoc('bold')" title="Bold"><i
                                class="fa-solid fa-bold"></i></button>
                        <button type="button" class="btn btn-icon btn-sm" onclick="formatDoc('italic')"
                            title="Italic"><i class="fa-solid fa-italic"></i></button>
                        <button type="button" class="btn btn-icon btn-sm" onclick="formatDoc('underline')"
                            title="Underline"><i class="fa-solid fa-underline"></i></button>
                        <div style="width: 1px; height: 20px; background: var(--border); margin: 0 0.5rem;"></div>
                        <input type="color" id="text-color" onchange="formatDoc('foreColor', this.value)"
                            title="Text Color"
                            style="cursor: pointer; border: none; background: none; width: 30px; height: 30px; padding: 0;">
                    </div>

                    <!-- Editor Area -->
                    <div id="post-editor" contenteditable="true"
                        style="min-height: 100px; padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 0 0 8px 8px; outline: none; margin-bottom: 1rem;"
                        placeholder="Share your knowledge..."></div>

                    <!-- Hidden Input for Logic -->
                    <input type="file" id="post-media" style="display: none;"
                        accept="image/*,video/*,audio/*,application/pdf">

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button type="button" class="btn btn-outline"
                                onclick="document.getElementById('post-media').click()">
                                <i class="fa-solid fa-paperclip"></i> Attach File
                            </button>
                            <span id="file-name" style="font-size: 0.9rem; color: var(--text-muted);"></span>
                        </div>
                        <button type="submit" class="btn btn-primary">Post</button>
                    </div>
                </form>
            </div>

            <!-- Posts -->
            <!-- Posts -->
            <div id="feed-container">
                <div style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading feed...</div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="sidebar">
            <div class="card" style="margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem; font-size: 1rem;">Trending Notes</h3>
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                    <i class="fa-solid fa-file-pdf" style="color: #ef4444; font-size: 1.2rem;"></i>
                    <div>
                        <div style="font-weight: 600; font-size: 0.9rem;">Cloud Computing 101</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">2k downloads</div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <i class="fa-solid fa-file-pdf" style="color: #ef4444; font-size: 1.2rem;"></i>
                    <div>
                        <div style="font-weight: 600; font-size: 0.9rem;">Azure Architecture</div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">1.5k downloads</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 1rem; font-size: 1rem;">Connections</h3>
                <div style="color: var(--text-muted); font-size: 0.9rem;">No new suggestions.</div>
            </div>
        </aside>
    </div>

    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();

            // Set User Info
            const avatarUrl = `https://ui-avatars.com/api/?name=${currentUser.username}&background=2563eb&color=fff`;
            document.getElementById('nav-avatar').src = avatarUrl;
            document.getElementById('side-avatar').src = avatarUrl;
            document.getElementById('side-name').textContent = currentUser.username;

            // Initial Load
            loadPosts();

            // Search & Filter Handler
            const searchInput = document.getElementById('search-input');
            const filterUni = document.getElementById('filter-university');
            const filterSubject = document.getElementById('filter-subject');
            const filterRole = document.getElementById('filter-role');
            const filterCountry = document.getElementById('filter-country');
            const filterMedia = document.getElementById('filter-media');

            // Toggle Filters
            document.getElementById('filter-toggle').addEventListener('click', () => {
                const menu = document.getElementById('filter-menu');
                menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
            });

            function handleSearch() {
                const q = searchInput.value.trim();
                loadPosts(
                    q,
                    filterUni.value,
                    filterSubject.value,
                    filterRole.value,
                    filterCountry.value,
                    filterMedia.value
                );
            }

            document.getElementById('search-icon').addEventListener('click', handleSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearch();
            });

            // Live Search (Debounced)
            let timeout = null;
            searchInput.addEventListener('input', () => {
                clearTimeout(timeout);
                timeout = setTimeout(handleSearch, 300);
            });

            // Listen to all changes
            [filterUni, filterSubject, filterRole, filterCountry, filterMedia].forEach(el => {
                el.addEventListener('change', handleSearch);
            });

            // Rich Text Formatting
            window.formatDoc = function (cmd, value) {
                document.execCommand(cmd, false, value);
                document.getElementById('post-editor').focus();
            }

            // File Name Update
            document.getElementById('post-media').addEventListener('change', function () {
                if (this.files[0]) document.getElementById('file-name').textContent = this.files[0].name;
            });

            // Post Creation
            document.getElementById('create-post-form').onsubmit = async function (e) {
                e.preventDefault();
                const content = document.getElementById('post-editor').innerHTML;
                const mediaFile = document.getElementById('post-media').files[0];

                if (document.getElementById('post-editor').textContent.trim() === '' && !mediaFile) {
                    alert('Please write something!');
                    return;
                }

                const formData = new FormData();
                formData.append('userId', currentUser.id);
                formData.append('username', currentUser.username);
                formData.append('content', content);
                if (mediaFile) formData.append('media', mediaFile);

                try {
                    const res = await fetch('/api/content', { method: 'POST', body: formData });
                    if (res.ok) {
                        document.getElementById('post-editor').innerHTML = '';
                        document.getElementById('post-media').value = '';
                        document.getElementById('file-name').textContent = '';
                        loadPosts();
                    } else {
                        alert('Failed to post');
                    }
                } catch (err) {
                    console.error('Error posting:', err);
                }
            };
        });

        // ---------------------------------------------------------
        // GLOBAL HELPERS (Outside DOMContentLoaded)
        // ---------------------------------------------------------

        async function loadPosts(query = '', uni = '', sub = '', role = '', country = '', media = '') {
            try {
                let url = '/api/content';
                const params = new URLSearchParams();
                if (query) params.append('search', query);
                if (uni) params.append('university', uni);
                if (sub) params.append('subject', sub);
                if (role) params.append('role', role);
                if (country) params.append('country', country);
                if (media) params.append('mediaType', media);
                if (params.toString()) url += `?${params.toString()}`;

                const response = await fetch(url);
                const posts = await response.json();
                renderPostsLocal(posts, 'feed-container');
            } catch (error) {
                console.error('Error loading posts:', error);
                const container = document.getElementById('feed-container');
                if (container) container.innerHTML = '<div style="text-align: center; color: red; padding: 2rem;">Failed to load posts: ' + error.message + '</div>';
            }
        }

        function renderPostsLocal(posts, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (posts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No posts found.</div>';
                return;
            }

            posts.forEach(post => {
                const div = document.createElement('div');
                div.className = 'card post';

                let mediaHtml = '';
                if (post.mediaUrl) {
                    const isVideo = post.mediaType && post.mediaType.startsWith('video/');
                    const isImage = post.mediaType && post.mediaType.startsWith('image/');
                    const isAudio = post.mediaType && (post.mediaType.startsWith('audio/') || post.mediaType === 'audio/mpeg');

                    if (isImage) {
                        mediaHtml = `<div class="post-media"><img src="${post.mediaUrl}" alt="Post media" style="width:100%; display:block;"></div>`;
                    } else if (isVideo) {
                        mediaHtml = `<div class="post-media"><video src="${post.mediaUrl}" controls style="width:100%"></video></div>`;
                    } else if (isAudio) {
                        mediaHtml = `<div class="post-media" style="padding: 1rem; background: var(--background); border-radius: 8px;"><audio src="${post.mediaUrl}" controls style="width:100%"></audio></div>`;
                    } else {
                        const fileName = post.mediaUrl.split('/').pop().split('?')[0];
                        mediaHtml = `
                            <div class="file-attachment">
                                <div class="file-icon"><i class="fa-solid fa-file-arrow-down"></i></div>
                                <div style="flex: 1; overflow: hidden;">
                                    <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${fileName}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">Document</div>
                                </div>
                                <a href="${post.mediaUrl}" download target="_blank" class="btn btn-primary" style="font-size: 0.8rem;">Download</a>
                            </div>`;
                    }
                }

                // Actions
                const canModify = post.userId === currentUser.id || currentUser.role === 'admin';
                let actionBtns = '';
                if (canModify) {
                    actionBtns = `
                        <div style="display: flex; gap: 0.5rem;" id="actions-${post.id}">
                            <button onclick="toggleEdit('${post.id}')" class="btn btn-icon" style="color: var(--text-muted);" title="Edit"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deletePost('${post.id}')" class="btn btn-icon" style="color: #ef4444;" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        </div>`;
                }

                const avatarUrl = `https://ui-avatars.com/api/?name=${post.username}&background=random`;

                // Truncation
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = post.content || '';
                const textLength = tempDiv.textContent.length;
                const isLong = textLength > 300;
                const collapseClass = isLong ? 'collapsed-content' : '';
                const seeMoreBtn = isLong ? `<button id="btn-expand-${post.id}" onclick="toggleExpand('${post.id}')" class="btn btn-link" style="padding: 0; margin-top: 0.5rem; color: var(--primary);">See More</button>` : '';

                div.innerHTML = `
                    <div class="post-header">
                        <div class="user-info">
                            <div class="avatar"><img src="${avatarUrl}" alt="User"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--text);">${post.username}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Posted on ${new Date(post.createdAt).toLocaleDateString()}</div>
                            </div>
                        </div>
                        ${actionBtns}
                    </div>
                    <div id="content-${post.id}" class="post-content ${collapseClass}" style="outline: none;">${post.content}</div>
                    ${seeMoreBtn}
                    ${mediaHtml}
                `;
                container.appendChild(div);
            });
        }

        // Window Functions
        window.deletePost = async (id) => {
            if (!confirm('Are you sure you want to delete this post?')) return;
            try {
                await fetch('/api/content/' + id, { method: 'DELETE' });
                loadPosts();
            } catch (e) { alert('Delete failed: ' + e.message); }
        };

        window.toggleExpand = (id) => {
            const contentDiv = document.getElementById('content-' + id);
            if (contentDiv) {
                contentDiv.classList.toggle('collapsed-content');
                const btn = document.getElementById('btn-expand-' + id);
                if (btn) btn.textContent = contentDiv.classList.contains('collapsed-content') ? 'See More' : 'See Less';
            }
        };

        window.toggleEdit = (id) => {
            const contentDiv = document.getElementById('content-' + id);
            if (!contentDiv) return;
            if (!contentDiv.isContentEditable) {
                contentDiv.contentEditable = "true";
                contentDiv.focus();
                contentDiv.style.border = "1px dashed #2563eb";
                contentDiv.style.padding = "0.5rem";
                contentDiv.style.borderRadius = "4px";

                const actionsDiv = document.getElementById('actions-' + id);
                if (actionsDiv) {
                    actionsDiv.innerHTML = `
                        <button onclick="saveEdit('${id}')" class="btn btn-primary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Save</button>
                        <button onclick="cancelEdit('${id}')" class="btn btn-outline btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Cancel</button>
                    `;
                }
            }
        };

        window.cancelEdit = (id) => {
            loadPosts();
        };

        window.saveEdit = async (id) => {
            const contentDiv = document.getElementById('content-' + id);
            const newContent = contentDiv.innerHTML;
            try {
                const res = await fetch('/api/content/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, content: newContent })
                });
                if (res.ok) {
                    alert('Post updated!');
                    loadPosts();
                } else {
                    alert('Update failed');
                    loadPosts();
                }
            } catch (e) {
                console.error(e);
                alert('Update failed: ' + e.message);
            }
        };
    </script> });
    </script>
</body>

</html>